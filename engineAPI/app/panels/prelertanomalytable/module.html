<div ng-controller='prelertanomalytable' ng-init='init()'>
  <style>
    .table-doc-table {
      margin-left: 0px !important;
      overflow-y: auto;
    }
    .table-sidebar {
      width: 200px;
      display: table-cell;
      padding-right: 10px;
    }
    .table-main {
      width: 100%;
      display: table-cell;
    }
    .table-container {
      display: table;
      height: 100px;
      width: 100%;
      table-layout: fixed;
    }
    .table-fieldname {
      white-space: nowrap;
    }

    .table-fieldname a {
      word-wrap:break-word;
      white-space: normal;
    }

    .table-details {
      table-layout: fixed;
    }

    .table-details-field {
      width: 200px;
    }

    .table-details-action {
      width: 60px;
      text-align: center;
    }

    .table-details-value {
    }

    .table-field-value {
      white-space: pre-wrap;
    }
    
    .anomaly-score-critical,
    .unusual-score-critical {
      color: #ff0000;
    }
    
    .anomaly-score-major,
    .unusual-score-major {
      color: #ffb429;
    }
    
    .anomaly-score-minor,
    .unusual-score-minor {
      color: #ffff00;
    }
    
    .anomaly-score-warning {
      color: #63b8ff;
    }
    
    .anomaly-score-none,
    .unusual-score-none,
    .unusual-score-warning {
      visibility: hidden;
    }
    
    
  </style>

  <div class="table-container">

    <div bindonce ng-class="{'table-sidebar':panel.field_list}" ng-if="panel.field_list">
      <div class="sidebar-nav">

        <strong>Fields <i class=" icon-chevron-sign-left pointer " ng-click="panel.field_list = !panel.field_list" bs-tooltip="'Hide field list'"></i></strong><p>

        <div class="small">
          <span class="small strong">Current ({{current_fields.length || 0}})</span>
        </div>

        <div><input type="text" class="input-medium" placeholder="Type to filter..." ng-model="fieldFilter">
        </div>

        <ul class="unstyled" style="{{panel.overflow}}:{{panel.height || row.height}};overflow-y:auto;overflow-x:hidden;">
          <li class="table-fieldname"  ng-style="panel.style" ng-repeat="field in current_fields|filter:fieldFilter|orderBy:identity">
            <i class="pointer" ng-class="{'icon-check': columns[field],'icon-check-empty': _.isUndefined(columns[field])}" ng-click="toggle_field(field)"></i>
            <a class="pointer" data-unique="1" bs-popover="'app/panels/prelertanomalytable/micropanel.html'" data-placement="rightTop" ng-click="toggle_micropanel(field,true)" ng-class="{label: columns[field]}" bo-text="field"></a>
          </li>
        </ul>

      </div>
    </div>

    <div style="{{panel.overflow}}:{{panel.height || row.height}};" ng-class="{'table-main':panel.field_list}" class="table-doc-table">

      <div class="table-facet" ng-if="modalField">
        <h4><button class="btn btn-mini btn-danger" ng-click="closeFacet();">close</button> Top 10 terms in field {{modalField}}</h4>
        <kibana-simple-panel type="'{{facetType}}'" panel='{{facetPanel}}' ng-cloak></kibana-simple-panel>
      </div>

      <i class="pull-left icon-chevron-sign-right pointer" ng-click="panel.field_list = !panel.field_list" bs-tooltip="'Show field list'" ng-show="!panel.field_list"></i>
      <div class="row-fluid" ng-show="panel.paging">
        <div class="span1 offset1" style="text-align:right">
          <i ng-click="panel.offset = 0" ng-show="panel.offset > 0" class='icon-circle-arrow-left pointer'></i>
          <i ng-click="panel.offset = (panel.offset - panel.size)" ng-show="panel.offset > 0" class='icon-arrow-left pointer'></i>
        </div>
        <div class="span8" style="text-align:center">
          <strong>{{panel.offset}}</strong> to <strong>{{panel.offset + data.slice(panel.offset,panel.offset+panel.size).length}}</strong>
          <small> of {{data.length}} available for paging</small>
        </div>
        <div class="span1" style="text-align:left">
          <i ng-click="panel.offset = (panel.offset + panel.size)" ng-show="data.length > panel.offset+panel.size" class='icon-arrow-right pointer'></i>
        </div>
      </div>
      <table class="table-hover table table-condensed" ng-style="panel.style">
        <thead ng-show="panel.header">
          <th ng-show="panel.linkShow">&nbsp;</th>
          <th ng-show="_.intersection(current_fields, panel.fields).length<1">_source (select columns from the list to the left)</th>
          <th style="white-space:nowrap" ng-repeat="field in panel.fields" ng-show="_.contains(current_fields, field)">
            <i ng-show="!$first" class="pointer link icon-caret-left" ng-click="_.move(panel.fields,$index,$index-1)"></i>

            <span  class="pointer" ng-click="set_sort(field)" ng-show='panel.sortable'>
              {{field}}
              <i ng-show='field == panel.sort[0]' class="pointer link" ng-class="{'icon-chevron-up': panel.sort[1] == 'asc','icon-chevron-down': panel.sort[1] == 'desc'}"></i>
            </span>
            <span ng-show='!panel.sortable'>{{field}}</span>
            <i ng-show="!$last" class="pointer link icon-caret-right" ng-click="_.move(panel.fields,$index,$index+1)"></i>
          </th>

        </thead>
        <tbody bindonce ng-repeat="event in data| slice:panel.offset:panel.offset+panel.size" ng-class-odd="'odd'">
          <tr ng-click="toggle_details(event)" class="pointer">
            <td ng-show="panel.linkShow">
              <a ng-click="show_data($event, event.kibana._source)" bs-tooltip="'Show data'"><i class="icon-external-link"></i></a>
            </td>
            <td ng-if="_.intersection(current_fields, panel.fields).length<1" bo-text="event|stringify|tableCellTextTruncate:panel.trimFactor:1"></td>
            <td ng-repeat="field in panel.fields" ng-show="panel.fields.length>0 && _.contains(current_fields, field)">
              <span ng-if="field == 'anomalyScore'" class="table-field-value"><i class='icon-flag' ng-class="'anomaly-score-' + event.severity">&nbsp;</i> {{(event[field]) | anomalyScore}}</i></span>
              <span ng-if="field == 'recordUnusualness'" class="table-field-value"><i class='icon-warning-sign' ng-class="'unusual-score-' + event.unusualSeverity">&nbsp;</i> {{(event[field]) | anomalyScore}}</i></span>
              <span ng-if="field != 'anomalyScore' && field != 'recordUnusualness' && (!panel.localTime || panel.timeField != field)" bo-html="(event[field]) | tableCellTextTruncate:panel.trimFactor:panel.fields.length" class="table-field-value"></span>
              <span ng-if="panel.localTime && panel.timeField == field" bo-html="(event[field]) | formatLocalTime:event[field]:panel.timeFormat" class="table-field-value"></span> 
            </td>
          </tr>
          <tr ng-if="event.kibana.details">
            <td colspan={{(panel.fields.length+2)}} ng-switch="event.kibana.view">
              <span>
                View:
                <span ng-if="_.contains(current_fields, 'overFieldName')"><a class="link" ng-class="{'strong':event.kibana.view == 'causes'}" ng-click="event.kibana.view = 'causes'">Causes</a> / </span>
                <a class="link" ng-class="{'strong':event.kibana.view == 'table'}" ng-click="event.kibana.view = 'table'">Table</a> /
                <a class="link" ng-class="{'strong':event.kibana.view == 'json'}" ng-click="event.kibana.view = 'json'">JSON</a> /
                <a class="link" ng-class="{'strong':event.kibana.view == 'raw'}" ng-click="event.kibana.view = 'raw'">Raw</a>
                <i class="link pull-right icon-chevron-up" ng-click="toggle_details(event)"></i>
              </span>
              <table class='table table-bordered table-condensed table-details' ng-switch-when="causes">
                <th style="white-space:nowrap" ng-repeat="field in get_causes_fields(event)">
                  <span>{{field}}</span>
                </th>
                <tbody bindonce ng-repeat="cause in event.causes" ng-class-odd="'odd'">
                  <tr class="pointer">
                    <td ng-repeat="field in get_causes_fields(event)">
                      <span bo-html="(cause[field])" class="table-field-value"></span>
                    </td>
                  </tr>
                </tbody>  
              </table>
              <table class='table table-bordered table-condensed table-details' ng-switch-when="table">
                <thead>
                  <th class="table-details-field">Field</th>
                  <th class="table-details-action">Action</th>
                  <th class="table-details-value">Value</th>
                </thead>
                <tr ng-repeat="(key,value) in event.kibana._source track by $index" ng-class-odd="'odd'">
                  <td style="word-wrap:break-word" bo-text="key"></td>
                  <td style="white-space:nowrap">
                    <i ng-if="_.contains(current_fields, key)" class="pointer icon-th" ng-click="toggle_field(key)" bs-tooltip="'Toggle table column'"></i>
                  </td>
                  <!-- At some point we need to create a more efficient way of applying the filter pipeline -->
                  <td style="white-space:pre-wrap;word-wrap:break-word" bo-html="value|noXml|urlLink|stringify"></td>
                </tr>
              </table>
              <pre style="white-space:pre-wrap;word-wrap:break-word"  bo-html="without_kibana(event)|tableCellObjectJsonFormat:2" ng-switch-when="json"></pre>
              <pre bo-html="without_kibana(event)|tableCellObjectJsonFormat:1" ng-switch-when="raw"></pre>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="row-fluid" ng-show="panel.paging">
        <div class="span1 offset3" style="text-align:right">
          <i ng-click="panel.offset = 0" ng-show="panel.offset > 0" class='icon-circle-arrow-left pointer'></i>
          <i ng-click="panel.offset = (panel.offset - panel.size)" ng-show="panel.offset > 0" class='icon-arrow-left pointer'></i>
        </div>
        <div class="span4" style="text-align:center">
          <strong>{{panel.offset}}</strong> to <strong>{{panel.offset + data.slice(panel.offset,panel.offset+panel.size).length}}</strong>
          <small> of {{data.length}} available for paging</small>
        </div>
        <div class="span1" style="text-align:left">
          <i ng-click="panel.offset = (panel.offset + panel.size)" ng-show="data.length > panel.offset+panel.size" class='icon-arrow-right pointer'></i>
        </div>
      </div>
    </div>
  </div>
</div>
